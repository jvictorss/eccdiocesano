<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Editar Setor</title>
    <link rel="stylesheet" type="text/css" href="/verbum-ecc/css/create_diocese.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/verbum-ecc/js/functions.js"></script>
</head>
<body>
<div id="navbar" th:replace="~{fragments/navbar :: navbar}"></div>
<div>
    </br>
    <h1>Editar Setor</h1>
    <form>
        <input type="hidden" id="idSetor" th:value="${setor.id}" />
        <div class="grid-section">
            <div>
                <label for="nome">Nome do Setor:</label>
                <input type="text" id="nome" th:value="${setor.nome}" />
            </div>
            <div>
                <label for="isActive">Ativo:</label>
                <input type="checkbox" id="isActive" th:checked="${setor.isActive}" />
            </div>
        </div>
        <div>
            <button type="button" class="salvar" onclick="saveSetor()">Salvar</button>
            <button type="button" class="btn-cancel" onclick="cancel()">Voltar</button>
        </div>
    </form>
</div>
<footer th:replace="~{fragments/footer :: footer}"></footer>
<script>
    async function fetchDioceseName(idDiocese) {
        try {
            const response = await fetch(`/verbum-ecc/v1/diocese/get/${idDiocese}`);
            if (response.ok) {
                const diocese = await response.json();
                document.getElementById('idDiocese').value = diocese.nome;
            } else {
                console.error('Failed to fetch diocese name');
                document.getElementById('idDiocese').value = 'Unknown';
            }
        } catch (error) {
            console.error('Error fetching diocese name:', error);
            document.getElementById('idDiocese').value = 'Unknown';
        }
    }

    async function fetchSetorData(setorId) {
        try {
            const response = await fetch(`/verbum-ecc/v1/setorial/${setorId}`);
            if (response.ok) {
                const setor = await response.json();
                document.getElementById('nome').value = setor.nome;
                document.getElementById('isActive').checked = setor.isActive;
                fetchDioceseName(setor.diocese.id);
            } else {
                console.error('Failed to fetch setor data');
            }
        } catch (error) {
            console.error('Error fetching setor data:', error);
        }
    }

    async function saveSetor() {
        const setorId = document.getElementById('idSetor').value;
        const parameters = {
            nome: document.getElementById('nome').value,
            isActive: document.getElementById('isActive').checked
        };

        try {
            const response = await fetch(`/verbum-ecc/v1/setorial/${setorId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(parameters)
            });

            if (response.ok) {
                alert('Setor atualizado com sucesso!');
                window.location.href = '/verbum-ecc/v1/setor/view';
            } else {
                alert('Falha ao atualizar setor.');
            }
        } catch (error) {
            console.error('Error updating setor:', error);
        }
    }

    window.onload = function() {
        const setorId = document.getElementById('idSetor').value;
        fetchSetorData(setorId);
    };
</script>
</body>
</html>